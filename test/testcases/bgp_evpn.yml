---
defaults:
  module: bgp_evpn

testcases:
  - name: Create bgp with evpn settings
    changed: 2
    arguments:
      bgp:
         enable: true
         bgp_as: 18
         vlans:
           - id: 40
             state: present
             rd: "40:40"
             route_target:
               import: 
                 - "1:1"
                 - "100:100"
               export: 
                 - "2:2"
               both: 
                 - "3:3" 
             redistribute: learned
           - id: 50
             rd: "50:50"
             redistribute: learned
    setup: |
      no router bgp
      ip routing
    present: |
      router bgp 18
         vlan 40
            rd 40:40
            route-target import 1:1
            route-target both 3:3
            route-target import 100:100
            route-target export 2:2
            redistribute learned
         !
         vlan 50
            rd 50:50
            redistribute learned

  - name: Remove evpn vlan
    changed: 1
    arguments:
       bgp:
          enable: true
          bgp_as: 2020 
          vlans:
            - id: 40
              state: absent
    setup: |
       no router bgp
       ip routing 
       router bgp 2020 
       vlan 40
       rd 1:1
       vlan 50
       rd  50:50
    present: |
        router bgp 2020
           vlan 50
              rd 50:50        

  - name: Change existing rd
    change: 2
    arguments:
      bgp:
         enable: true
         bgp_as: 30
         vlans: 
           - id: 10
             rd: "100:100"
           - id: 20 
             rd: "200:200"
    setup: |
       no router bgp
       router bgp 30
       vlan 10
       rd 10:10
       vlan 20
       rd 20:20
    present: |
      router bgp 30
         vlan 10
            rd 100:100
         !
         vlan 20
            rd 200:200

  - name: Removing redistribute learning
    change: 1
    arguments:
       bgp:
          enable: true
          bgp_as: 4040
          vlans:
            - id: 10
    setup: |
       no router bgp
       router bgp 4040
       vlan 10
       redistribute learned
    present: |
       router bgp 4040
          vlan 10
     
